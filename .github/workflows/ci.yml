name: transport-core CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  # =========================
  # 1. Rust Core
  # =========================
  rust:
    name: Rust core tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        rust: [1.72.0, stable]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Rust tests
        run: |
          cd core
          cargo test --all

  fmt:
    name: Rust fmt
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Rust fmt
        run: |
          cd core
          cargo fmt -- --check

  # =========================
  # 2. C ABI Smoke Test
  # =========================
  ffi:
    name: C ABI smoke
    runs-on: ubuntu-latest
    needs: [rust, fmt]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Install build deps
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Build transport-core shared lib
        run: |
          cd core
          cargo build --release

      - name: Compile C smoke test
        run: |
          gcc \
            ffi_test/smoke_rate_limited.c \
            -Iffi \
            -Lcore/target/release \
            -ltransport_core \
            -o smoke_test

      - name: Run C smoke test
        run: |
          LD_LIBRARY_PATH=core/target/release ./smoke_test

  # =========================
  # 3. Python Binding
  # =========================
  python:
    name: Python binding
    runs-on: ubuntu-latest
    needs: [rust, fmt]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build shared lib
        run: |
          cd core
          cargo build --release

      - name: Install pytest
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run python smoke tests
        working-directory: bindings/python
        env:
          TRANSPORT_CORE_LIB: ${{ github.workspace }}/core/target/release/libtransport_core.so
          LD_LIBRARY_PATH: ${{ github.workspace }}/core/target/release
        run: |
          pytest -v

  # =========================
  # 4. Repo Hygiene
  # =========================
  hygiene:
    name: Repo hygiene
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Ensure no binaries committed
        run: |
          ! git ls-files | grep -E '\.(so|dll|dylib|pyc)$'
          ! git ls-files | grep -E '(^|/)target/'
