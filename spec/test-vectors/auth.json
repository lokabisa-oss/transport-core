{
  "description": "Authentication behavior test vectors for transport-core",
  "cases": [
    {
      "name": "apply_auth_before_request",
      "input": {
        "attempt": 1,
        "apply_auth_result": "OK"
      },
      "expected": {
        "action": "PROCEED"
      }
    },
    {
      "name": "fail_when_auth_application_fails",
      "input": {
        "attempt": 1,
        "apply_auth_result": "ERROR"
      },
      "expected": {
        "action": "FAIL",
        "error_category": "AuthError"
      }
    },
    {
      "name": "refresh_and_retry_on_401",
      "input": {
        "attempt": 1,
        "status": 401,
        "auth_decision": "RefreshAndRetry",
        "refresh_result": "SUCCESS"
      },
      "expected": {
        "action": "REFRESH_AND_RETRY",
        "next_attempt": 2
      }
    },
    {
      "name": "fail_on_401_when_provider_denies_refresh",
      "input": {
        "attempt": 1,
        "status": 401,
        "auth_decision": "Fail"
      },
      "expected": {
        "action": "FAIL",
        "error_category": "AuthError"
      }
    },
    {
      "name": "fail_when_refresh_fails",
      "input": {
        "attempt": 1,
        "status": 401,
        "auth_decision": "RefreshAndRetry",
        "refresh_result": "FAILURE"
      },
      "expected": {
        "action": "FAIL",
        "error_category": "AuthError"
      }
    },
    {
      "name": "single_flight_refresh_blocks_concurrent_requests",
      "input": {
        "concurrent_requests": 2,
        "status": 401,
        "auth_decision": "RefreshAndRetry",
        "refresh_result": "SUCCESS"
      },
      "expected": {
        "refresh_count": 1,
        "waiting_requests": 1,
        "action_after_refresh": "RETRY"
      }
    },
    {
      "name": "fail_when_401_reoccurs_after_successful_refresh",
      "input": {
        "attempt": 2,
        "status": 401,
        "refresh_already_attempted": true
      },
      "expected": {
        "action": "FAIL",
        "error_category": "AuthError"
      }
    },
    {
      "name": "do_not_refresh_on_403",
      "input": {
        "attempt": 1,
        "status": 403
      },
      "expected": {
        "action": "FAIL",
        "error_category": "FatalError"
      }
    },
    {
      "name": "do_not_refresh_on_rate_limit",
      "input": {
        "attempt": 1,
        "status": 429
      },
      "expected": {
        "action": "RETRY",
        "refresh_attempted": false
      }
    },
    {
      "name": "auth_state_shared_within_client_only",
      "input": {
        "client_instances": 2,
        "status": 401,
        "auth_decision": "RefreshAndRetry",
        "refresh_result": "SUCCESS"
      },
      "expected": {
        "refresh_per_client": 1
      }
    }
  ]
}
